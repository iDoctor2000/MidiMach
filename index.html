<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor MIDI Bajo y Bater√≠a</title>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@next/build/Midi.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #0ff;
      padding: 20px;
    }
    label, select, button, input {
      display: block;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    input, select, button {
      padding: 8px;
      background-color: #222;
      color: #0ff;
      border: 1px solid #0ff;
      border-radius: 4px;
    }
    button:hover {
      cursor: pointer;
      background-color: #0ff;
      color: #111;
    }
  </style>
</head>
<body>
  <h1>üéõÔ∏è Editor MIDI: Bajo y Bater√≠a</h1>

  <label>Selecciona archivo MIDI principal:</label>
  <input type="file" id="midiInput" accept=".mid">

  <label>Selecciona archivo de claqueta:</label>
  <input type="file" id="claquetaInput" accept=".mid">

  <label>Selecciona tipo de bajo (Program Change):</label>
  <select id="bajoSelector">
    <option value="33">Acoustic Bass</option>
    <option value="34">Electric Bass (finger)</option>
    <option value="35">Electric Bass (pick)</option>
    <option value="36">Fretless Bass</option>
    <option value="37">Slap Bass 1</option>
    <option value="38">Slap Bass 2</option>
    <option value="39">Synth Bass 1</option>
    <option value="40">Synth Bass 2</option>
  </select>

  <button id="procesar">Procesar y descargar MIDI</button>
  <p id="estado"></p>

  <script>
    const midiInput = document.getElementById("midiInput");
    const claquetaInput = document.getElementById("claquetaInput");
    const bajoSelector = document.getElementById("bajoSelector");
    const estado = document.getElementById("estado");

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    document.getElementById("procesar").addEventListener("click", async () => {
      if (!midiInput.files[0] || !claquetaInput.files[0]) {
        estado.textContent = "‚ö†Ô∏è Faltan archivos MIDI";
        return;
      }

      estado.textContent = "‚è≥ Cargando archivos...";

      const mainArrayBuffer = await midiInput.files[0].arrayBuffer();
      const claquetaArrayBuffer = await claquetaInput.files[0].arrayBuffer();

      const midi = new Midi(mainArrayBuffer);
      const claqueta = new Midi(claquetaArrayBuffer);

      // Detectar pistas de bater√≠a y bajo
      const bateriaTrack = midi.tracks.find(t => t.channel === 9 || t.name.toLowerCase().includes("drum"));
      const bajoTrack = midi.tracks.find(t => t.name.toLowerCase().includes("bass"));

      if (!bateriaTrack || !bajoTrack) {
        estado.textContent = "‚ùå No se detectaron correctamente las pistas de bater√≠a o bajo";
        return;
      }

      const claquetaTrack = claqueta.tracks[0];
      const claquetaTicks = claqueta.durationTicks;

      // Insertar claqueta al inicio de bater√≠a
      bateriaTrack.notes = [...claquetaTrack.notes.map(n => ({...n})), ...bateriaTrack.notes.map(n => ({...n, time: n.time + claqueta.duration}))];
      bateriaTrack.channel = 9;
      bateriaTrack.volume = { value: 120 };

      // Modificar pista de bajo
      bajoTrack.channel = 2;
      bajoTrack.volume = { value: 100 };
      const programChange = parseInt(bajoSelector.value);
      bajoTrack.instrument.number = programChange;
      bajoTrack.notes = bajoTrack.notes.map(n => ({...n, time: n.time + claqueta.duration}));

      // Insertar ProgramChange y Volume al inicio (no todos los lectores usan volume global)
      bajoTrack.controlChanges[7] = [{ time: 0, value: 100 }]; // CC 7 = Volume
      bajoTrack.programNumber = programChange;

      estado.textContent = "‚úÖ MIDI procesado, generando archivo...";
      await delay(500);

      const newFile = midi.toArray();
      const blob = new Blob([newFile], { type: 'audio/midi' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "MIDI_editado.mid";
      a.click();

      estado.textContent = "‚úÖ Archivo descargado con √©xito.";
    });
  </script>
</body>
</html>
